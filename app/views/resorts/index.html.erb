<!DOCTYPE html>
<html>
<head>
  <title>Powder Hunter - Backcountry Ski Resorts</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: #f4f7f6;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #2c3e50;
      color: #fff;
      padding: 20px 0;
      text-content: center;
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: 2.5em;
      letter-spacing: 1px;
    }
    p.subtitle {
      font-style: italic;
      margin-top: 10px;
      color: #bdc3c7;
    }
    .container {
      width: 80%;
      margin: 40px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }
    .resort-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 30%;
      margin-bottom: 30px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    .resort-card:hover {
      transform: translateY(-5px);
    }
    .resort-image {
      height: 200px;
      background-color: #ecf0f1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7f8c8d;
      font-size: 1.2em;
    }
    .resort-info {
      padding: 20px;
    }
    .resort-name {
      font-size: 1.5em;
      margin: 0 0 10px 0;
      color: #2980b9;
    }
    .resort-desc {
      line-height: 1.6;
      color: #555;
    }
    footer {
      text-align: center;
      padding: 20px;
      background-color: #2c3e50;
      color: #7f8c8d;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
    .route-btn {
      display: inline-block;
      margin-top: 15px;
      padding: 8px 15px;
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s ease;
    }
    .route-btn:hover {
      background-color: #2ecc71;
    }
  </style>
</head>
<body>

  <header>
    <div style="text-align: right; padding-right: 20px; font-size: 0.9em; margin-bottom: 10px;">
      <% if current_user&.admin? %>
        <%= link_to 'ç®¡ç†ç”»é¢', admin_ski_resorts_path, style: "color: #f1c40f; font-weight: bold; margin-right: 15px; text-decoration: underline;" %>
      <% end %>

      <% if user_signed_in? %>
        <%= link_to 'è¡¨ç¤ºã™ã‚‹ã‚¹ã‚­ãƒ¼å ´ã‚’ç·¨é›†ã™ã‚‹', selections_path, style: "color: #f39c12; font-weight: bold; margin-right: 15px; text-decoration: underline;", data: { turbo: false } %>
        <%= current_user.email %> ã•ã‚“ | 
        <%= button_to 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', destroy_user_session_path, method: :delete, data: { turbo: false }, form: { style: "display: inline-block; margin: 0;", data: { turbo: false } }, style: "background: none; border: none; padding: 0; color: #ecf0f1; text-decoration: underline; cursor: pointer; font-family: inherit; font-size: inherit;" %>
      <% else %>
        <%= link_to 'ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸', root_path, style: "color: #f39c12; font-weight: bold; margin-right: 15px; text-decoration: underline;" %>
        <%= link_to 'æ–°è¦ç™»éŒ²', new_user_registration_path, style: "color: #ecf0f1; text-decoration: underline;" %> | 
        <%= link_to 'ãƒ­ã‚°ã‚¤ãƒ³', new_user_session_path, style: "color: #ecf0f1; text-decoration: underline;" %>
      <% end %>
    </div>
    <h1>Powder Hunter</h1>
    <p class="subtitle">Find the best backcountry powder snow courses 2 weeks ahead (Coming Soon!)</p>
  </header>

  <div class="container" style="width: 80%; margin: 0 auto;">
    <% if notice %>
      <div style="text-align: center; padding: 15px; margin: 20px 0; background-color: #e8f8f5; color: #27ae60; font-weight: bold; border-radius: 8px;"><%= notice %></div>
    <% end %>
    <% if alert %>
      <div style="text-align: center; padding: 15px; margin: 20px 0; background-color: #fdf2e9; color: #e74c3c; font-weight: bold; border-radius: 8px;"><%= alert %></div>
    <% end %>
  </div>

  <div class="container">
    <% if user_signed_in? && @api_data.empty? %>
      <div style="text-align: center; padding: 50px; background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px; width: 100%;">
        <h2 style="color: #2c3e50; margin-bottom: 20px;">ã¾ã ã‚¹ã‚­ãƒ¼å ´ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“â›·ï¸</h2>
        <%= link_to 'ã“ã¡ã‚‰ã‹ã‚‰ã‚¹ã‚­ãƒ¼å ´ã‚’æœ€å¤§3ã¤é¸ã‚“ã§ãã ã•ã„', selections_path, style: "display: inline-block; padding: 15px 30px; background-color: #2980b9; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 1.1em;", data: { turbo: false } %>
      </div>
    <% else %>
      <% @api_data.each do |data| %>
        <div class="resort-card" data-testid="resort-card-<%= data[:resort].id %>">
          <div class="resort-image">
            <!-- Assign basic emoji depending on index -->
            <% if data[:powder_index] > 50 %>
              ğŸ”ï¸ POWDER!
            <% elsif data[:powder_index] > 0 %>
              â„ï¸ SNOWING
            <% else %>
              â›„ï¸
            <% end %>
          </div>
          <div class="resort-info">
            <h2 class="resort-name"><%= link_to data[:resort].name_ja.presence || data[:resort].name_en, resort_path(data[:resort]), style: "text-decoration: none; color: inherit;" %></h2>
            <p class="resort-desc">
              <strong>Powder Index: <%= data[:powder_index] %> / 100</strong><br>
              Next 24h Snow: <%= data[:next_24h_snow] %> cm<br>
              Expected Temp: <%= data[:temperature] %><br>
              <br>
              <% if data[:next_powder_day] %>
                <strong style="color: #2980b9;">ç›´è¿‘ã®ãƒãƒ£ãƒ³ã‚¹: <%= data[:next_powder_day][:date] %> (æŒ‡æ•°: <%= data[:next_powder_day][:index] %>)</strong><br>
              <% else %>
                <strong style="color: #7f8c8d;">ç›´è¿‘14æ—¥ã«ãƒ‘ã‚¦ãƒ€ãƒ¼äºˆå ±ã¯ã‚ã‚Šã¾ã›ã‚“</strong><br>
              <% end %>
              <br>
              <small>Elev: <%= data[:resort].elevation_base %>m | Lat: <%= data[:resort].latitude %> | Lon: <%= data[:resort].longitude %></small>
            </p>
            <button class="route-btn" 
                    data-testid="route-btn-<%= data[:resort].id %>"
                    data-lat="<%= data[:resort].latitude %>" 
                    data-lon="<%= data[:resort].longitude %>">
              ğŸš— ã“ã“ã¸ã®ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º
            </button>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const routeButtons = document.querySelectorAll(".route-btn");
      
      routeButtons.forEach(button => {
        button.addEventListener("click", (e) => {
          e.preventDefault();
          const destLat = button.dataset.lat;
          const destLon = button.dataset.lon;
          
          if ("geolocation" in navigator) {
            button.textContent = "ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...";
            button.disabled = true;

            navigator.geolocation.getCurrentPosition(
              (position) => {
                const originLat = position.coords.latitude;
                const originLon = position.coords.longitude;
                
                // Google Maps Universal URL
                const url = `https://www.google.com/maps/dir/?api=1&origin=${originLat},${originLon}&destination=${destLat},${destLon}&travelmode=driving`;
                window.open(url, "_blank");
                
                // Reset button
                button.textContent = "ğŸš— ã“ã“ã¸ã®ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º";
                button.disabled = false;
              },
              (error) => {
                console.error("Error getting location: ", error);
                alert("ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                
                // Reset button
                button.textContent = "ğŸš— ã“ã“ã¸ã®ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º";
                button.disabled = false;
              }
            );
          } else {
            alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã®å–å¾—ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
          }
        });
      });
    });
  </script>
</body>
</html>
