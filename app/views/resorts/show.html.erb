<% content_for :title, "#{@resort.name_ja.presence || @resort.name_en} - Powder Hunter" %>

<style>
  body {
    font-family: 'Helvetica Neue', Arial, sans-serif;
    background-color: #f4f7f6;
    color: #333;
    margin: 0;
    padding: 0;
  }
  header {
    background-color: #2c3e50;
    color: #fff;
    padding: 20px 0;
    text-align: center;
  }
  h1 {
    margin: 0;
    font-size: 2.5em;
  }
  .back-link {
    display: inline-block;
    margin: 20px auto;
    padding: 10px 20px;
    background-color: #3498db;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    font-weight: bold;
    transition: background-color 0.3s ease;
  }
  .back-link:hover {
    background-color: #2980b9;
  }
  .container {
    width: 80%;
    max-width: 800px;
    margin: 20px auto;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    text-align: center;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: center;
  }
  th {
    background-color: #ecf0f1;
    color: #2c3e50;
    font-weight: bold;
  }
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  tr:hover {
    background-color: #f1f1f1;
  }
  .high-powder {
    background-color: #d1ecf1 !important;
    font-weight: bold;
    color: #0c5460;
  }

  /* ===== Mobile Responsive ===== */
  @media (max-width: 768px) {
    h1 { font-size: 1.5em; }
    header p { font-size: 0.85em; }
    .container { width: 95%; padding: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    th, td { padding: 8px 6px; font-size: 0.8em; white-space: nowrap; }
    h2 { font-size: 1.2em; }
    .back-link { padding: 8px 15px; font-size: 0.9em; }
  }

  .comment-card {
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 12px;
    text-align: left;
  }
  .comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.85em;
    color: #888;
  }
  .comment-author { font-weight: bold; color: #555; }
  .comment-date { font-style: italic; }
  .comment-body { margin: 0 0 8px 0; line-height: 1.6; color: #333; word-break: break-word; }
  .comment-url { margin: 0; font-size: 0.9em; }
  .comment-url a { color: #2980b9; text-decoration: underline; }
  .comment-url a:hover { color: #1a5276; }
  .comment-actions { margin-top: 10px; display: flex; gap: 8px; }
  .btn-edit, .btn-delete, .btn-submit, .btn-cancel {
    padding: 6px 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    font-family: inherit;
    transition: background-color 0.3s ease;
  }
  .btn-edit { background-color: #f39c12; color: white; }
  .btn-edit:hover { background-color: #e67e22; }
  .btn-delete { background-color: #e74c3c; color: white; }
  .btn-delete:hover { background-color: #c0392b; }
  .btn-submit { background-color: #27ae60; color: white; padding: 10px 25px; font-size: 1em; }
  .btn-submit:hover { background-color: #2ecc71; }
  .btn-cancel { background-color: #95a5a6; color: white; }
  .btn-cancel:hover { background-color: #7f8c8d; }
  .comment-form-section {
    margin-top: 25px;
    padding-top: 20px;
    border-top: 2px solid #ecf0f1;
    text-align: left;
  }
  .comment-form-section h3 { color: #2c3e50; margin-bottom: 15px; }
</style>

<header>
  <h1><%= @resort.name_ja.presence || @resort.name_en %></h1>
  <p>Elevation: <%= @resort.elevation_base %>m | Lat: <%= @resort.latitude %> | Lon: <%= @resort.longitude %></p>
</header>

<div class="container">
  <%= link_to "‚Üê Êàª„Çã (Back to Resorts)", resorts_path, class: "back-link" %>
  
  <h2>14-Day Powder Forecast</h2>

  <% if @daily_forecasts.any? %>
    <table>
      <thead>
        <tr>
          <th>Êó•‰ªò (Date)</th>
          <th>Â§©Ê∞ó (Snowfall)</th>
          <th>ÊúÄ‰Ωé/ÊúÄÈ´òÊ∞óÊ∏© (Min/Max Temp)</th>
          <th>„Éë„Ç¶„ÉÄ„ÉºÊåáÊï∞ (Powder Index)</th>
        </tr>
      </thead>
      <tbody>
        <% @daily_forecasts.each do |forecast| %>
          <tr class="<%= 'high-powder' if forecast[:powder_index] > 50 %>">
            <td><%= forecast[:date] %></td>
            <td><%= forecast[:weather] %></td>
            <td><%= forecast[:min_temp] %>¬∞C / <%= forecast[:max_temp] %>¬∞C</td>
            <td><%= forecast[:powder_index] %> / 100</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p>Data could not be fetched. Please try again later.</p>
  <% end %>
</div>

<!-- ===== „Ç≥„É°„É≥„Éà„Çª„ÇØ„Ç∑„Éß„É≥ ===== -->
<div class="container" id="comments" style="margin-top: 10px;">
  <h2>üí¨ „Ç≥„É°„É≥„Éà</h2>

  <% if flash[:notice] %>
    <div style="padding: 10px; margin-bottom: 15px; background-color: #e8f8f5; color: #27ae60; border-radius: 5px; font-weight: bold;">
      <%= flash[:notice] %>
    </div>
  <% end %>
  <% if flash[:alert] %>
    <div style="padding: 10px; margin-bottom: 15px; background-color: #fdf2e9; color: #e74c3c; border-radius: 5px; font-weight: bold;">
      <%= flash[:alert] %>
    </div>
  <% end %>

  <% comments = @resort.comments.includes(:user).order(created_at: :desc) %>
  <% if comments.any? %>
    <% comments.each do |comment| %>
      <div class="comment-card" id="comment-<%= comment.id %>" data-comment-id="<%= comment.id %>">
        <div class="comment-header">
          <span class="comment-author"><%= comment.user.email.sub(/(.{3}).*@/, '\1***@') %></span>
          <span class="comment-date"><%= comment.created_at.strftime("%Y/%m/%d %H:%M") %></span>
        </div>

        <!-- Ë°®Á§∫„É¢„Éº„Éâ -->
        <div class="comment-display" data-display-for="<%= comment.id %>">
          <p class="comment-body"><%= comment.body %></p>
          <% if comment.url.present? %>
            <p class="comment-url">üîó <a href="<%= comment.url %>" target="_blank" rel="noopener noreferrer"><%= comment.url.truncate(60) %></a></p>
          <% end %>

          <% if user_signed_in? && current_user.id == comment.user_id %>
            <div class="comment-actions">
              <button type="button" class="btn-edit" onclick="toggleEdit(<%= comment.id %>)">‚úèÔ∏è Á∑®ÈõÜ</button>
              <%= button_to "üóëÔ∏è ÂâäÈô§", resort_comment_path(@resort, comment), method: :delete,
                  data: { turbo: false },
                  class: "btn-delete",
                  form: { style: "display: inline-block;", onsubmit: "return confirm('„Åì„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');" } %>
            </div>
          <% end %>
        </div>

        <!-- Á∑®ÈõÜ„É¢„Éº„ÉâÔºàÂàùÊúüÈùûË°®Á§∫Ôºâ -->
        <% if user_signed_in? && current_user.id == comment.user_id %>
          <div class="comment-edit" data-edit-for="<%= comment.id %>" style="display: none;">
            <%= form_with(model: comment, url: resort_comment_path(@resort, comment), method: :patch, data: { turbo: false }, local: true) do |f| %>
              <div style="margin-bottom: 10px;">
                <%= f.text_area :body, rows: 3, maxlength: 256, class: "comment-input",
                    style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; font-family: inherit;",
                    oninput: "updateCounter(this, 'edit-counter-#{comment.id}')" %>
                <small id="edit-counter-<%= comment.id %>" style="color: #999;"><%= comment.body.length %>/256</small>
              </div>
              <div style="margin-bottom: 10px;">
                <%= f.text_field :url, placeholder: "https://example.comÔºà‰ªªÊÑèÔºâ", class: "comment-input",
                    style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;" %>
              </div>
              <div>
                <%= f.submit "Êõ¥Êñ∞", class: "btn-submit" %>
                <button type="button" class="btn-cancel" onclick="toggleEdit(<%= comment.id %>)">„Ç≠„É£„É≥„Çª„É´</button>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <p style="color: #999; font-style: italic;">„Åæ„Å†„Ç≥„É°„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊúÄÂàù„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
  <% end %>

  <!-- ÊäïÁ®ø„Éï„Ç©„Éº„É†Ôºà„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÔºâ -->
  <% if user_signed_in? %>
    <div class="comment-form-section" id="comment-form">
      <h3>„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø„Åô„Çã</h3>
      <%= form_with(model: Comment.new, url: resort_comments_path(@resort), method: :post, data: { turbo: false }, local: true) do |f| %>
        <div style="margin-bottom: 10px;">
          <%= f.text_area :body, rows: 3, maxlength: 256, placeholder: "„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÊúÄÂ§ß256ÊñáÂ≠óÔºâ",
              class: "comment-input",
              style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; font-family: inherit;",
              oninput: "updateCounter(this, 'new-counter')" %>
          <small id="new-counter" style="color: #999;">0/256</small>
        </div>
        <div style="margin-bottom: 10px;">
          <%= f.text_field :url, placeholder: "https://example.comÔºà‰ªªÊÑèÔºâ",
              class: "comment-input",
              style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;" %>
        </div>
        <div>
          <%= f.submit "ÊäïÁ®ø„Åô„Çã", class: "btn-submit" %>
        </div>
      <% end %>
    </div>
  <% else %>
    <p style="text-align: center; margin-top: 20px;">
      <%= link_to "„É≠„Ç∞„Ç§„É≥", new_user_session_path, style: "color: #2980b9; font-weight: bold;" %>„Åô„Çã„Å®„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø„Åß„Åç„Åæ„Åô„ÄÇ
    </p>
  <% end %>
</div>

<script>
  function toggleEdit(commentId) {
    const display = document.querySelector(`[data-display-for="${commentId}"]`);
    const edit = document.querySelector(`[data-edit-for="${commentId}"]`);
    if (display && edit) {
      const isEditing = edit.style.display !== 'none';
      display.style.display = isEditing ? 'block' : 'none';
      edit.style.display = isEditing ? 'none' : 'block';
    }
  }

  function updateCounter(textarea, counterId) {
    const counter = document.getElementById(counterId);
    if (counter) {
      counter.textContent = `${textarea.value.length}/256`;
      counter.style.color = textarea.value.length > 240 ? '#e74c3c' : '#999';
    }
  }
</script>


